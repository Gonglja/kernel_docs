<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Definitive SEV Guest API Documentation &mdash; The Linux Kernel  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_rtd_colors.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Hyper-V Enlightenments" href="../hyperv/index.html" />
    <link rel="prev" title="ACRN CPUID bits" href="../acrn/cpuid.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          </a>
              <div class="version">
                6.1.0-rc6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux Virtualization Support</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../kvm/index.html">KVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../uml/user_mode_linux_howto_v2.html">UML HowTo</a></li>
<li class="toctree-l3"><a class="reference internal" href="../paravirt_ops.html">Paravirt_ops</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guest-halt-polling.html">Guest halt polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ne_overview.html">Nitro Enclaves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../acrn/index.html">ACRN Hypervisor</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The Definitive SEV Guest API Documentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#general-description">1. General description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-description">2. API description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sev-snp-cpuid-enforcement">3. SEV-SNP CPUID Enforcement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../hyperv/index.html">Hyper-V Enlightenments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../subsystem-apis.html">Kernel subsystem documentation</a> &raquo;</li>
          <li><a href="../index.html">Linux Virtualization Support</a> &raquo;</li>
      <li>The Definitive SEV Guest API Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/virt/coco/sev-guest.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-definitive-sev-guest-api-documentation">
<h1>The Definitive SEV Guest API Documentation<a class="headerlink" href="#the-definitive-sev-guest-api-documentation" title="Permalink to this heading">¶</a></h1>
<section id="general-description">
<h2>1. General description<a class="headerlink" href="#general-description" title="Permalink to this heading">¶</a></h2>
<p>The SEV API is a set of ioctls that are used by the guest or hypervisor
to get or set a certain aspect of the SEV virtual machine. The ioctls belong
to the following classes:</p>
<blockquote>
<div><ul class="simple">
<li><p>Hypervisor ioctls: These query and set global attributes which affect the
whole SEV firmware.  These ioctl are used by platform provisioning tools.</p></li>
<li><p>Guest ioctls: These query and set attributes of the SEV virtual machine.</p></li>
</ul>
</div></blockquote>
</section>
<section id="api-description">
<h2>2. API description<a class="headerlink" href="#api-description" title="Permalink to this heading">¶</a></h2>
<p>This section describes ioctls that is used for querying the SEV guest report
from the SEV firmware. For each ioctl, the following information is provided
along with a description:</p>
<blockquote>
<div><dl class="simple">
<dt>Technology:</dt><dd><p>which SEV technology provides this ioctl. SEV, SEV-ES, SEV-SNP or all.</p>
</dd>
<dt>Type:</dt><dd><p>hypervisor or guest. The ioctl can be used inside the guest or the
hypervisor.</p>
</dd>
<dt>Parameters:</dt><dd><p>what parameters are accepted by the ioctl.</p>
</dd>
<dt>Returns:</dt><dd><p>the return value.  General error numbers (-ENOMEM, -EINVAL)
are not detailed, but errors with specific meanings are.</p>
</dd>
</dl>
</div></blockquote>
<p>The guest ioctl should be issued on a file descriptor of the /dev/sev-guest device.
The ioctl accepts struct snp_user_guest_request. The input and output structure is
specified through the req_data and resp_data field respectively. If the ioctl fails
to execute due to a firmware error, then fw_err code will be set otherwise the
fw_err will be set to 0x00000000000000ff.</p>
<p>The firmware checks that the message sequence counter is one greater than
the guests message sequence counter. If guest driver fails to increment message
counter (e.g. counter overflow), then -EIO will be returned.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct snp_guest_request_ioctl {
        /* Message version number */
        __u32 msg_version;

        /* Request and response structure address */
        __u64 req_data;
        __u64 resp_data;

        /* firmware error code on failure (see psp-sev.h) */
        __u64 fw_err;
};
</pre></div>
</div>
<section id="snp-get-report">
<h3>2.1 SNP_GET_REPORT<a class="headerlink" href="#snp-get-report" title="Permalink to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_report_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_REPORT ioctl can be used to query the attestation report from the
SEV-SNP firmware. The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command
provided by the SEV-SNP firmware to query the attestation report.</p>
<p>On success, the snp_report_resp.data will contains the report. The report
contain the format described in the SEV-SNP specification. See the SEV-SNP
specification for further details.</p>
</section>
<section id="snp-get-derived-key">
<h3>2.2 SNP_GET_DERIVED_KEY<a class="headerlink" href="#snp-get-derived-key" title="Permalink to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_derived_key_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_derived_key_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_DERIVED_KEY ioctl can be used to get a key derive from a root key.
The derived key can be used by the guest for any purpose, such as sealing keys
or communicating with external entities.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_KEY_REQ) command provided by the
SEV-SNP firmware to derive the key. See SEV-SNP specification for further details
on the various fields passed in the key derivation request.</p>
<p>On success, the snp_derived_key_resp.data contains the derived key value. See
the SEV-SNP specification for further details.</p>
</section>
<section id="snp-get-ext-report">
<h3>2.3 SNP_GET_EXT_REPORT<a class="headerlink" href="#snp-get-ext-report" title="Permalink to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Technology<span class="colon">:</span></dt>
<dd class="field-odd"><p>sev-snp</p>
</dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><p>guest ioctl</p>
</dd>
<dt class="field-odd">Parameters (in/out)<span class="colon">:</span></dt>
<dd class="field-odd"><p>struct snp_ext_report_req</p>
</dd>
<dt class="field-even">Returns (out)<span class="colon">:</span></dt>
<dd class="field-even"><p>struct snp_report_resp on success, -negative on error</p>
</dd>
</dl>
<p>The SNP_GET_EXT_REPORT ioctl is similar to the SNP_GET_REPORT. The difference is
related to the additional certificate data that is returned with the report.
The certificate data returned is being provided by the hypervisor through the
SNP_SET_EXT_CONFIG.</p>
<p>The ioctl uses the SNP_GUEST_REQUEST (MSG_REPORT_REQ) command provided by the SEV-SNP
firmware to get the attestation report.</p>
<p>On success, the snp_ext_report_resp.data will contain the attestation report
and snp_ext_report_req.certs_address will contain the certificate blob. If the
length of the blob is smaller than expected then snp_ext_report_req.certs_len will
be updated with the expected value.</p>
<p>See GHCB specification for further detail on how to parse the certificate blob.</p>
</section>
</section>
<section id="sev-snp-cpuid-enforcement">
<h2>3. SEV-SNP CPUID Enforcement<a class="headerlink" href="#sev-snp-cpuid-enforcement" title="Permalink to this heading">¶</a></h2>
<p>SEV-SNP guests can access a special page that contains a table of CPUID values
that have been validated by the PSP as part of the SNP_LAUNCH_UPDATE firmware
command. It provides the following assurances regarding the validity of CPUID
values:</p>
<blockquote>
<div><ul class="simple">
<li><p>Its address is obtained via bootloader/firmware (via CC blob), and those
binaries will be measured as part of the SEV-SNP attestation report.</p></li>
<li><p>Its initial state will be encrypted/pvalidated, so attempts to modify
it during run-time will result in garbage being written, or #VC exceptions
being generated due to changes in validation state if the hypervisor tries
to swap the backing page.</p></li>
<li><p>Attempts to bypass PSP checks by the hypervisor by using a normal page, or
a non-CPUID encrypted page will change the measurement provided by the
SEV-SNP attestation report.</p></li>
<li><p>The CPUID page contents are <em>not</em> measured, but attempts to modify the
expected contents of a CPUID page as part of guest initialization will be
gated by the PSP CPUID enforcement policy checks performed on the page
during SNP_LAUNCH_UPDATE, and noticeable later if the guest owner
implements their own checks of the CPUID values.</p></li>
</ul>
</div></blockquote>
<p>It is important to note that this last assurance is only useful if the kernel
has taken care to make use of the SEV-SNP CPUID throughout all stages of boot.
Otherwise, guest owner attestation provides no assurance that the kernel wasn’t
fed incorrect values at some point during boot.</p>
<section id="reference">
<h3>Reference<a class="headerlink" href="#reference" title="Permalink to this heading">¶</a></h3>
<p>SEV-SNP and GHCB specification: developer.amd.com/sev</p>
<p>The driver is based on SEV-SNP firmware spec 0.9 and GHCB spec version 2.0.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../acrn/cpuid.html" class="btn btn-neutral float-left" title="ACRN CPUID bits" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../hyperv/index.html" class="btn btn-neutral float-right" title="Hyper-V Enlightenments" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The kernel development community.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>