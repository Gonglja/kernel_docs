<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPF_MAP_TYPE_HASH, with PERCPU and LRU Variants &mdash; The Linux Kernel  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Running BPF programs from userspace" href="bpf_prog_run.html" />
    <link rel="prev" title="BPF_MAP_TYPE_CGROUP_STORAGE" href="map_cgroup_storage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          </a>
              <div class="version">
                6.1.0-rc6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l2"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l2"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">BPF Documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="instruction-set.html"><span class="sectnum">1 </span>eBPF Instruction Set Specification, v1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="verifier.html">eBPF verifier</a></li>
<li class="toctree-l3"><a class="reference internal" href="libbpf/index.html">libbpf</a></li>
<li class="toctree-l3"><a class="reference internal" href="btf.html">BPF Type Format (BTF)</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l3"><a class="reference internal" href="syscall_api.html">Syscall API</a></li>
<li class="toctree-l3"><a class="reference internal" href="helpers.html">Helper functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="kfuncs.html">BPF Kernel Functions (kfuncs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="programs.html">Program Types</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="maps.html">eBPF maps</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="maps.html#map-types">Map Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="bpf_prog_run.html">Running BPF programs from userspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="classic_vs_extended.html">Classic BPF vs eBPF</a></li>
<li class="toctree-l3"><a class="reference internal" href="bpf_licensing.html">BPF licensing</a></li>
<li class="toctree-l3"><a class="reference internal" href="test_debug.html">Testing and debugging BPF</a></li>
<li class="toctree-l3"><a class="reference internal" href="clang-notes.html"><span class="sectnum">1 </span>Clang implementation notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="linux-notes.html"><span class="sectnum">1 </span>Linux implementation notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="other.html">Other</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../subsystem-apis.html">Kernel subsystem documentation</a> &raquo;</li>
          <li><a href="index.html">BPF Documentation</a> &raquo;</li>
          <li><a href="maps.html">eBPF maps</a> &raquo;</li>
      <li>BPF_MAP_TYPE_HASH, with PERCPU and LRU Variants</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/bpf/map_hash.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bpf-map-type-hash-with-percpu-and-lru-variants">
<h1>BPF_MAP_TYPE_HASH, with PERCPU and LRU Variants<a class="headerlink" href="#bpf-map-type-hash-with-percpu-and-lru-variants" title="Permalink to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_HASH</span></code> was introduced in kernel version 3.19</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code> was introduced in version 4.6</p></li>
<li><p>Both <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_HASH</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_PERCPU_HASH</span></code>
were introduced in version 4.10</p></li>
</ul>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_HASH</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code> provide general
purpose hash map storage. Both the key and the value can be structs,
allowing for composite keys and values.</p>
<p>The kernel is responsible for allocating and freeing key/value pairs, up
to the max_entries limit that you specify. Hash maps use pre-allocation
of hash table elements by default. The <code class="docutils literal notranslate"><span class="pre">BPF_F_NO_PREALLOC</span></code> flag can be
used to disable pre-allocation when it is too memory expensive.</p>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code> provides a separate value slot per
CPU. The per-cpu values are stored internally in an array.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_HASH</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_PERCPU_HASH</span></code>
variants add LRU semantics to their respective hash tables. An LRU hash
will automatically evict the least recently used entries when the hash
table reaches capacity. An LRU hash maintains an internal LRU list that
is used to select elements for eviction. This internal LRU list is
shared across CPUs but it is possible to request a per CPU LRU list with
the <code class="docutils literal notranslate"><span class="pre">BPF_F_NO_COMMON_LRU</span></code> flag when calling <code class="docutils literal notranslate"><span class="pre">bpf_map_create</span></code>.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<dl class="c function">
<dt class="sig sig-object c" id="c.bpf_map_update_elem">
<span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">bpf_map_update_elem</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">bpf_map</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">map</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">key</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">value</span></span>, <span class="n"><span class="pre">u64</span></span><span class="w"> </span><span class="n"><span class="pre">flags</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.bpf_map_update_elem" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>Hash entries can be added or updated using the <code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem()</span></code>
helper. This helper replaces existing elements atomically. The <code class="docutils literal notranslate"><span class="pre">flags</span></code>
parameter can be used to control the update behaviour:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_ANY</span></code> will create a new element or update an existing element</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_NOEXIST</span></code> will create a new element only if one did not already
exist</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BPF_EXIST</span></code> will update an existing element</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem()</span></code> returns 0 on success, or negative error in
case of failure.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.bpf_map_lookup_elem">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">bpf_map_lookup_elem</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">bpf_map</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">map</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">key</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.bpf_map_lookup_elem" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>Hash entries can be retrieved using the <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem()</span></code>
helper. This helper returns a pointer to the value associated with
<code class="docutils literal notranslate"><span class="pre">key</span></code>, or <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if no entry was found.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.bpf_map_delete_elem">
<span class="kt"><span class="pre">long</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">bpf_map_delete_elem</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">bpf_map</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">map</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">key</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.bpf_map_delete_elem" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>Hash entries can be deleted using the <code class="docutils literal notranslate"><span class="pre">bpf_map_delete_elem()</span></code>
helper. This helper will return 0 on success, or negative error in case
of failure.</p>
<section id="per-cpu-hashes">
<h3>Per CPU Hashes<a class="headerlink" href="#per-cpu-hashes" title="Permalink to this heading">¶</a></h3>
<p>For <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_HASH</span></code> and <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_LRU_PERCPU_HASH</span></code>
the <code class="docutils literal notranslate"><span class="pre">bpf_map_update_elem()</span></code> and <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_elem()</span></code> helpers
automatically access the hash slot for the current CPU.</p>
<dl class="c function">
<dt class="sig sig-object c" id="c.bpf_map_lookup_percpu_elem">
<span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="sig-name descname"><span class="n"><span class="pre">bpf_map_lookup_percpu_elem</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">struct</span></span><span class="w"> </span><span class="n"><span class="pre">bpf_map</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">map</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">key</span></span>, <span class="n"><span class="pre">u32</span></span><span class="w"> </span><span class="n"><span class="pre">cpu</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.bpf_map_lookup_percpu_elem" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">bpf_map_lookup_percpu_elem()</span></code> helper can be used to lookup the
value in the hash slot for a specific CPU. Returns value associated with
<code class="docutils literal notranslate"><span class="pre">key</span></code> on <code class="docutils literal notranslate"><span class="pre">cpu</span></code> , or <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if no entry was found or <code class="docutils literal notranslate"><span class="pre">cpu</span></code> is
invalid.</p>
</section>
<section id="concurrency">
<h3>Concurrency<a class="headerlink" href="#concurrency" title="Permalink to this heading">¶</a></h3>
<p>Values stored in <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_HASH</span></code> can be accessed concurrently by
programs running on different CPUs.  Since Kernel version 5.1, the BPF
infrastructure provides <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_spin_lock</span></code> to synchronise access.
See <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/bpf/progs/test_spin_lock.c</span></code>.</p>
</section>
<section id="userspace">
<h3>Userspace<a class="headerlink" href="#userspace" title="Permalink to this heading">¶</a></h3>
<dl class="c function">
<dt class="sig sig-object c" id="c.bpf_map_get_next_key">
<span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-name descname"><span class="n"><span class="pre">bpf_map_get_next_key</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="n"><span class="pre">fd</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">cur_key</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n"><span class="pre">next_key</span></span><span class="sig-paren">)</span><a class="headerlink" href="#c.bpf_map_get_next_key" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>In userspace, it is possible to iterate through the keys of a hash using
libbpf’s <code class="docutils literal notranslate"><span class="pre">bpf_map_get_next_key()</span></code> function. The first key can be fetched by
calling <code class="docutils literal notranslate"><span class="pre">bpf_map_get_next_key()</span></code> with <code class="docutils literal notranslate"><span class="pre">cur_key</span></code> set to
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>. Subsequent calls will fetch the next key that follows the
current key. <code class="docutils literal notranslate"><span class="pre">bpf_map_get_next_key()</span></code> returns 0 on success, -ENOENT if
cur_key is the last key in the hash, or negative error in case of
failure.</p>
<p>Note that if <code class="docutils literal notranslate"><span class="pre">cur_key</span></code> gets deleted then <code class="docutils literal notranslate"><span class="pre">bpf_map_get_next_key()</span></code>
will instead return the <em>first</em> key in the hash table which is
undesirable. It is recommended to use batched lookup if there is going
to be key deletion intermixed with <code class="docutils literal notranslate"><span class="pre">bpf_map_get_next_key()</span></code>.</p>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<p>Please see the <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/bpf</span></code> directory for functional
examples.  The code snippets below demonstrates API usage.</p>
<p>This example shows how to declare an LRU Hash with a struct key and a
struct value.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">key</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">__u32</span><span class="w"> </span><span class="n">srcip</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">packets</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">__u64</span><span class="w"> </span><span class="n">bytes</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_LRU_HASH</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">packet_stats</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>This example shows how to create or update hash values using atomic
instructions:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update_stats</span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">srcip</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">key</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">srcip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcip</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_stats</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="n">newval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_stats</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newval</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_NOEXIST</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Userspace walking the map elements from the map declared above:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf.h&gt;</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">walk_hash_elements</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">map_fd</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">key</span><span class="w"> </span><span class="o">*</span><span class="n">cur_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">key</span><span class="w"> </span><span class="n">next_key</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_get_next_key</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span><span class="w"> </span><span class="n">cur_key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">next_key</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">                </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="n">map_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">next_key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="c1">// Use key and value here</span>

<span class="w">                </span><span class="n">cur_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">next_key</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="map_cgroup_storage.html" class="btn btn-neutral float-left" title="BPF_MAP_TYPE_CGROUP_STORAGE" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bpf_prog_run.html" class="btn btn-neutral float-right" title="Running BPF programs from userspace" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The kernel development community.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>