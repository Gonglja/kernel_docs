<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPF_MAP_TYPE_CGROUP_STORAGE &mdash; The Linux Kernel  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BPF_MAP_TYPE_HASH, with PERCPU and LRU Variants" href="map_hash.html" />
    <link rel="prev" title="eBPF maps" href="maps.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          </a>
              <div class="version">
                6.1.0-rc6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../process/development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/code-of-conduct.html">Code of conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">All development-process docs</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystem-apis.html">Kernel subsystem documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l2"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l2"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">BPF Documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="instruction-set.html"><span class="sectnum">1 </span>eBPF Instruction Set Specification, v1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="verifier.html">eBPF verifier</a></li>
<li class="toctree-l3"><a class="reference internal" href="libbpf/index.html">libbpf</a></li>
<li class="toctree-l3"><a class="reference internal" href="btf.html">BPF Type Format (BTF)</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html">Frequently asked questions (FAQ)</a></li>
<li class="toctree-l3"><a class="reference internal" href="syscall_api.html">Syscall API</a></li>
<li class="toctree-l3"><a class="reference internal" href="helpers.html">Helper functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="kfuncs.html">BPF Kernel Functions (kfuncs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="programs.html">Program Types</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="maps.html">eBPF maps</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="maps.html#map-types">Map Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="bpf_prog_run.html">Running BPF programs from userspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="classic_vs_extended.html">Classic BPF vs eBPF</a></li>
<li class="toctree-l3"><a class="reference internal" href="bpf_licensing.html">BPF licensing</a></li>
<li class="toctree-l3"><a class="reference internal" href="test_debug.html">Testing and debugging BPF</a></li>
<li class="toctree-l3"><a class="reference internal" href="clang-notes.html"><span class="sectnum">1 </span>Clang implementation notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="linux-notes.html"><span class="sectnum">1 </span>Linux implementation notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="other.html">Other</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">Locking in the kernel</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/testing-overview.html">Kernel Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rust/index.html">Rust</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">The kernel build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/reporting-issues.html">Reporting issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">User-space tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../subsystem-apis.html">Kernel subsystem documentation</a> &raquo;</li>
          <li><a href="index.html">BPF Documentation</a> &raquo;</li>
          <li><a href="maps.html">eBPF maps</a> &raquo;</li>
      <li>BPF_MAP_TYPE_CGROUP_STORAGE</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/bpf/map_cgroup_storage.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bpf-map-type-cgroup-storage">
<h1>BPF_MAP_TYPE_CGROUP_STORAGE<a class="headerlink" href="#bpf-map-type-cgroup-storage" title="Permalink to this heading">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CGROUP_STORAGE</span></code> map type represents a local fix-sized
storage. It is only available with <code class="docutils literal notranslate"><span class="pre">CONFIG_CGROUP_BPF</span></code>, and to programs that
attach to cgroups; the programs are made available by the same Kconfig. The
storage is identified by the cgroup the program is attached to.</p>
<p>The map provide a local storage at the cgroup that the BPF program is attached
to. It provides a faster and simpler access than the general purpose hash
table, which performs a hash table lookups, and requires user to track live
cgroups on their own.</p>
<p>This document describes the usage and semantics of the
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CGROUP_STORAGE</span></code> map type. Some of its behaviors was changed in
Linux 5.9 and this document will describe the differences.</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p>The map uses key of type of either <code class="docutils literal notranslate"><span class="pre">__u64</span> <span class="pre">cgroup_inode_id</span></code> or
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_cgroup_storage_key</span></code>, declared in <code class="docutils literal notranslate"><span class="pre">linux/bpf.h</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct bpf_cgroup_storage_key {
        __u64 cgroup_inode_id;
        __u32 attach_type;
};
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cgroup_inode_id</span></code> is the inode id of the cgroup directory.
<code class="docutils literal notranslate"><span class="pre">attach_type</span></code> is the program’s attach type.</p>
<p>Linux 5.9 added support for type <code class="docutils literal notranslate"><span class="pre">__u64</span> <span class="pre">cgroup_inode_id</span></code> as the key type.
When this key type is used, then all attach types of the particular cgroup and
map will share the same storage. Otherwise, if the type is
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_cgroup_storage_key</span></code>, then programs of different attach types
be isolated and see different storages.</p>
<p>To access the storage in a program, use <code class="docutils literal notranslate"><span class="pre">bpf_get_local_storage</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void *bpf_get_local_storage(void *map, u64 flags)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">flags</span></code> is reserved for future use and must be 0.</p>
<p>There is no implicit synchronization. Storages of <code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CGROUP_STORAGE</span></code>
can be accessed by multiple programs across different CPUs, and user should
take care of synchronization by themselves. The bpf infrastructure provides
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_spin_lock</span></code> to synchronize the storage. See
<code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/bpf/progs/test_spin_lock.c</span></code>.</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<p>Usage with key type as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_cgroup_storage_key</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;bpf/bpf.h&gt;

struct {
        __uint(type, BPF_MAP_TYPE_CGROUP_STORAGE);
        __type(key, struct bpf_cgroup_storage_key);
        __type(value, __u32);
} cgroup_storage SEC(&quot;.maps&quot;);

int program(struct __sk_buff *skb)
{
        __u32 *ptr = bpf_get_local_storage(&amp;cgroup_storage, 0);
        __sync_fetch_and_add(ptr, 1);

        return 0;
}
</pre></div>
</div>
<p>Userspace accessing map declared above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;linux/bpf.h&gt;
#include &lt;linux/libbpf.h&gt;

__u32 map_lookup(struct bpf_map *map, __u64 cgrp, enum bpf_attach_type type)
{
        struct bpf_cgroup_storage_key = {
                .cgroup_inode_id = cgrp,
                .attach_type = type,
        };
        __u32 value;
        bpf_map_lookup_elem(bpf_map__fd(map), &amp;key, &amp;value);
        // error checking omitted
        return value;
}
</pre></div>
</div>
<p>Alternatively, using just <code class="docutils literal notranslate"><span class="pre">__u64</span> <span class="pre">cgroup_inode_id</span></code> as key type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;bpf/bpf.h&gt;

struct {
        __uint(type, BPF_MAP_TYPE_CGROUP_STORAGE);
        __type(key, __u64);
        __type(value, __u32);
} cgroup_storage SEC(&quot;.maps&quot;);

int program(struct __sk_buff *skb)
{
        __u32 *ptr = bpf_get_local_storage(&amp;cgroup_storage, 0);
        __sync_fetch_and_add(ptr, 1);

        return 0;
}
</pre></div>
</div>
<p>And userspace:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;linux/bpf.h&gt;
#include &lt;linux/libbpf.h&gt;

__u32 map_lookup(struct bpf_map *map, __u64 cgrp, enum bpf_attach_type type)
{
        __u32 value;
        bpf_map_lookup_elem(bpf_map__fd(map), &amp;cgrp, &amp;value);
        // error checking omitted
        return value;
}
</pre></div>
</div>
</section>
<section id="semantics">
<h2>Semantics<a class="headerlink" href="#semantics" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</span></code> is a variant of this map type. This
per-CPU variant will have different memory regions for each CPU for each
storage. The non-per-CPU will have the same memory region for each storage.</p>
<p>Prior to Linux 5.9, the lifetime of a storage is precisely per-attachment, and
for a single <code class="docutils literal notranslate"><span class="pre">CGROUP_STORAGE</span></code> map, there can be at most one program loaded
that uses the map. A program may be attached to multiple cgroups or have
multiple attach types, and each attach creates a fresh zeroed storage. The
storage is freed upon detach.</p>
<p>There is a one-to-one association between the map of each type (per-CPU and
non-per-CPU) and the BPF program during load verification time. As a result,
each map can only be used by one BPF program and each BPF program can only use
one storage map of each type. Because of map can only be used by one BPF
program, sharing of this cgroup’s storage with other BPF programs were
impossible.</p>
<p>Since Linux 5.9, storage can be shared by multiple programs. When a program is
attached to a cgroup, the kernel would create a new storage only if the map
does not already contain an entry for the cgroup and attach type pair, or else
the old storage is reused for the new attachment. If the map is attach type
shared, then attach type is simply ignored during comparison. Storage is freed
only when either the map or the cgroup attached to is being freed. Detaching
will not directly free the storage, but it may cause the reference to the map
to reach zero and indirectly freeing all storage in the map.</p>
<p>The map is not associated with any BPF program, thus making sharing possible.
However, the BPF program can still only associate with one map of each type
(per-CPU and non-per-CPU). A BPF program cannot use more than one
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_CGROUP_STORAGE</span></code> or more than one
<code class="docutils literal notranslate"><span class="pre">BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</span></code>.</p>
<p>In all versions, userspace may use the attach parameters of cgroup and
attach type pair in <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">bpf_cgroup_storage_key</span></code> as the key to the BPF map
APIs to read or update the storage for a given attachment. For Linux 5.9
attach type shared storages, only the first value in the struct, cgroup inode
id, is used during comparison, so userspace may just specify a <code class="docutils literal notranslate"><span class="pre">__u64</span></code>
directly.</p>
<p>The storage is bound at attach time. Even if the program is attached to parent
and triggers in child, the storage still belongs to the parent.</p>
<p>Userspace cannot create a new entry in the map or delete an existing entry.
Program test runs always use a temporary storage.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="maps.html" class="btn btn-neutral float-left" title="eBPF maps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="map_hash.html" class="btn btn-neutral float-right" title="BPF_MAP_TYPE_HASH, with PERCPU and LRU Variants" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The kernel development community.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>